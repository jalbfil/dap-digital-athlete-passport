{% extends "base.html" %}

{% block title %}DAP ‚Äî Issuer (Emisor){% endblock %}

{% block content %}
<div class="grid grid-2">
    
    <div class="card">
        <div class="card-pad">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2>‚úçÔ∏è Emitir Credencial</h2>
                <button class="btn ok" id="btn-ocr" onclick="document.getElementById('ocrInput').click()" style="padding: 8px 12px; font-size: 0.85em;">
                    üì∏ Escanear (OCR)
                </button>
                <input type="file" id="ocrInput" accept="image/*" style="display:none" onchange="handleOcr(this)">
            </div>

            <p class="muted" style="margin-bottom: 20px;">
                Define los datos de la credencial (JSON). Puedes escribirlos a mano o escanear una clasificaci√≥n.
            </p>

            <label for="vcJson">Contenido de la Credencial (Claims)</label>
            <textarea id="vcJson" spellcheck="false" style="font-size: 0.9em; font-family: 'Consolas', monospace;"></textarea>

            <div class="grid grid-2" style="margin-bottom: 20px;">
                <div>
                    <label for="subjectDid">DID del Atleta (Holder)</label>
                    <input type="text" id="subjectDid" value="did:example:athlete:5678">
                </div>
                <div>
                    <label for="ttl">Validez (Segundos)</label>
                    <input type="number" id="ttl" value="31536000"> </div>
            </div>

            <button id="btnEmitir" class="btn primary" style="width: 100%;" onclick="issueCredential()">
                Firmar y Emitir Credencial
            </button>
        </div>
    </div>

    <div class="card" id="resultCard" style="opacity: 0.6; pointer-events: none; transition: opacity 0.3s;">
        <div class="card-pad">
            <h2>üéâ Resultado de Emisi√≥n</h2>
            
            <div class="row" style="margin-bottom: 20px; align-items: center; justify-content: space-between;">
                <div>
                    <span class="muted" style="font-size: 0.9em; display: block;">Estado</span>
                    <span id="statusBadge" class="badge" style="margin-top: 5px;">PENDIENTE</span>
                </div>
                <div style="text-align: right;">
                    <span class="muted" style="font-size: 0.9em; display: block;">ID √önico (JTI)</span>
                    <code id="resJti" style="color: var(--accent);">‚Äî</code>
                </div>
            </div>

            <label>Token Firmado (VC-JWT)</label>
            <div class="code" id="resultToken" style="min-height: 150px; margin-bottom: 20px; font-size: 0.8em; word-break: break-all;">
                El token firmado aparecer√° aqu√≠...
            </div>

            <div id="actions" class="hidden" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <a href="#" id="linkQr" target="_blank" class="btn">üî≥ Ver QR</a>
                <a href="#" id="linkJson" target="_blank" class="btn">üìÑ JSON</a>
                <a href="/holder" target="_blank" class="btn primary">üì± Ir al Holder</a>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // --- 1. Inicializaci√≥n ---
    const defaultVC = {
        "type": ["VerifiableCredential", "RaceResultCredential"],
        "issuer": "did:web:jalbfil.github.io", 
        "credentialSubject": {
            "event": "HYROX M√ÅLAGA 24",
            "bib": "",
            "name": "",
            "result": { 
                "time": "",
                "category": "Pro Men"
            }
        }
    };
    
    const textArea = document.getElementById('vcJson');
    textArea.value = JSON.stringify(defaultVC, null, 4);

    // --- 2. L√≥gica OCR (IA) ---
    async function handleOcr(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const btn = document.getElementById('btn-ocr');
            const originalText = btn.innerHTML;
            
            // UI Loading
            btn.innerHTML = '<span class="spinner"></span> Analizando...';
            btn.disabled = true;
            
            const formData = new FormData();
            formData.append("file", file);

            try {
                const res = await fetch('/issuer/ocr', {
                    method: 'POST',
                    body: formData
                });

                if(!res.ok) throw new Error("Error en el servidor OCR");
                const data = await res.json();

                // Mezclar datos con el JSON actual
                let currentJson;
                try {
                    currentJson = JSON.parse(textArea.value);
                } catch (e) {
                    currentJson = defaultVC; 
                }
                
                let subj = currentJson.credentialSubject;
                let changes = [];
                
                // Inyecci√≥n inteligente
                if(data.event) { subj.event = data.event; changes.push("Evento"); }
                if(data.bib)   { subj.bib = data.bib; changes.push("Dorsal"); }
                if(data.name)  { subj.name = data.name.toUpperCase(); changes.push("Nombre"); }
                if(data.time)  { subj.result.time = data.time; changes.push("Tiempo"); }
                
                // Actualizar UI
                textArea.value = JSON.stringify(currentJson, null, 4);
                
                if (changes.length > 0) {
                    btn.innerHTML = `‚úÖ Datos detectados (${changes.length})`;
                    btn.classList.remove('ok'); btn.classList.add('primary');
                    setTimeout(() => { 
                        btn.innerHTML = originalText; 
                        btn.classList.remove('primary'); btn.classList.add('ok');
                    }, 3000);
                } else {
                    alert("‚ö†Ô∏è El OCR funcion√≥, pero no se detectaron datos claros de carrera.");
                    btn.innerHTML = originalText;
                }

            } catch(e) {
                alert("‚ùå Error OCR: " + e.message);
                btn.innerHTML = originalText;
            } finally {
                btn.disabled = false;
                input.value = ''; 
            }
        }
    }

    // --- 3. L√≥gica Emisi√≥n ---
    async function issueCredential() {
        const vcContent = document.getElementById('vcJson').value;
        const subDid = document.getElementById('subjectDid').value;
        const ttl = document.getElementById('ttl').value;
        const btnEmitir = document.getElementById('btnEmitir');
        const resultCard = document.getElementById('resultCard');
        const statusBadge = document.getElementById('statusBadge');
        const resJti = document.getElementById('resJti');
        const resultToken = document.getElementById('resultToken');
        
        // UI Feedback
        btnEmitir.innerHTML = '<span class="spinner"></span> Firmando...';
        btnEmitir.disabled = true;
        
        statusBadge.innerText = "PROCESANDO...";
        statusBadge.className = "badge"; // Reset clases

        try {
            let payload;
            try {
                payload = JSON.parse(vcContent);
            } catch(e) {
                throw new Error("El JSON tiene errores de sintaxis.");
            }

            const res = await fetch(`/issuer/issue?ttl=${ttl}&subject_did=${subDid}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const err = await res.json();
                let errorMsg = err.detail;
                if (typeof errorMsg === 'object') errorMsg = JSON.stringify(errorMsg);
                throw new Error(errorMsg || "Error desconocido");
            }

            const data = await res.json();

            // √âxito
            statusBadge.innerText = "EMITIDA";
            statusBadge.classList.add("valid");
            
            // Activar tarjeta resultado
            resultCard.style.opacity = "1";
            resultCard.style.pointerEvents = "auto";

            resJti.innerText = data.jti;
            resultToken.innerText = data.token; 

            // Configurar botones
            document.getElementById('linkQr').href = `/holder/${data.jti}/qr.png`;
            document.getElementById('linkJson').href = `/holder/${data.jti}.json`;
            
            document.getElementById('actions').classList.remove('hidden');
            document.getElementById('actions').classList.add('visible');

        } catch (e) {
            console.error(e);
            alert("Error de emisi√≥n:\n" + e.message);
            statusBadge.innerText = "ERROR";
            statusBadge.classList.add("revoked");
        } finally {
            btnEmitir.innerHTML = 'Firmar y Emitir Credencial';
            btnEmitir.disabled = false;
        }
    }
</script>
{% endblock %}
