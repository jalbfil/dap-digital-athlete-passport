{% extends "base.html" %}

{% block title %}DAP ‚Äî Verifier (Auditor√≠a){% endblock %}

{% block content %}
<div class="grid grid-2">
    
    <div class="card">
        <div class="card-pad">
            <h2>üîé Auditor√≠a de Credenciales</h2>
            <p class="muted" style="margin-bottom: 25px;">
                Herramienta para jueces y terceros. Verifica la autenticidad, integridad y vigencia de una credencial.
            </p>

            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 25px; border: 1px dashed var(--border);">
                <label style="color: var(--accent);">PASO 1: Protocolo Anti-Replay</label>
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <div style="flex-grow: 1;">
                        <span class="muted" style="font-size: 0.8em;">Generar un "Reto" (Nonce) criptogr√°fico</span>
                        <input type="text" id="nonceInput" placeholder="Pulsa el bot√≥n para generar..." readonly 
                               style="background: transparent; border: none; padding: 0; color: #fff; font-family: monospace; font-size: 1.1em; margin-top: 5px;">
                    </div>
                    <button class="btn ok" onclick="getChallenge()" style="padding: 8px 12px; font-size: 0.85em;">
                        üé≤ 1. Pedir Challenge
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label for="tokenInput">PASO 2: Token a Verificar (VC-JWT)</label>
                <textarea id="tokenInput" placeholder="Pega aqu√≠ el token proporcionado por el atleta (eyJ...)" 
                          style="font-family: monospace; font-size: 0.85em; color: #a5b4fc;"></textarea>
            </div>

            <button class="btn primary" style="width: 100%; margin-top: 10px;" onclick="verifyCredential()">
                üîç 2. Verificar Integridad
            </button>
        </div>
    </div>

    <div class="card" id="reportCard" style="opacity: 0.5; pointer-events: none; transition: opacity 0.3s;">
        <div class="card-pad">
            <h2>üìã Informe de Validaci√≥n</h2>
            
            <div style="text-align: center; margin: 20px 0;">
                <span id="statusBadge" class="badge" style="font-size: 1.2em; padding: 8px 20px;">ESPERANDO DATOS</span>
            </div>

            <div id="checksContainer" class="hidden" style="margin-top: 30px;">
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
                    <span class="muted">1. Firma Criptogr√°fica (RS256)</span>
                    <strong id="checkSig" style="color: var(--muted);">--</strong>
                </div>

                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
                    <span class="muted">2. Nonce (Anti-Replay)</span>
                    <strong id="checkNonce" style="color: var(--muted);">--</strong>
                </div>

                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
                    <span class="muted">3. Estado (Revocaci√≥n)</span>
                    <strong id="checkStatus" style="color: var(--muted);">--</strong>
                </div>

                <div style="background: #020617; padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span class="muted" style="font-size: 0.8em;">EMISOR (DID)</span>
                        <code id="resIss" style="font-size: 0.8em; color: var(--accent);">--</code>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span class="muted" style="font-size: 0.8em;">CREDENTIAL ID (JTI)</span>
                        <code id="resJti" style="font-size: 0.8em;">--</code>
                    </div>
                    
                    <label>Datos Certificados (Claims)</label>
                    <pre id="claimsBox" style="color: #cbd5e1; font-size: 0.85em; white-space: pre-wrap; margin: 0;">--</pre>
                </div>

            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // 1. Obtener Challenge (Nonce)
    async function getChallenge() {
        const input = document.getElementById('nonceInput');
        input.value = "Generando...";
        input.style.color = "#fcd34d"; // Amarillo mientras carga

        try {
            const res = await fetch('/verifier/challenge?ttl=120');
            const data = await res.json();
            
            input.value = data.nonce;
            input.style.color = "#4ade80"; // Verde al terminar
            
            // Animaci√≥n visual de foco en el siguiente paso
            document.getElementById('tokenInput').focus();
            
        } catch(e) {
            alert("Error conectando con servidor");
            input.value = "Error";
            input.style.color = "#f87171";
        }
    }

    // 2. Verificar Credencial
    async function verifyCredential() {
        const token = document.getElementById('tokenInput').value.trim();
        const nonce = document.getElementById('nonceInput').value.trim();
        const reportCard = document.getElementById('reportCard');
        const badge = document.getElementById('statusBadge');

        if(!token) return alert("Por favor pega un token VC-JWT para verificar.");

        // UI Loading
        reportCard.style.opacity = "1";
        reportCard.style.pointerEvents = "auto";
        badge.innerText = "AUDITANDO...";
        badge.className = "badge"; // Reset colores
        
        try {
            // Enviamos Token + Nonce (si existe)
            // Si el usuario no pidi√≥ challenge, mandamos null y el backend saltar√° esa comprobaci√≥n (o la marcar√° como skipped)
            const payload = { token: token };
            if (nonce && nonce !== "Generando..." && nonce !== "Error") {
                payload.nonce = nonce;
            }

            const res = await fetch('/verifier/verify', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            renderResult(data);

        } catch(e) {
            alert("Error cr√≠tico en verificaci√≥n: " + e.message);
            badge.innerText = "ERROR SISTEMA";
            badge.classList.add("revoked");
        }
    }

    function renderResult(data) {
        const container = document.getElementById('checksContainer');
        container.classList.remove('hidden');
        container.classList.add('visible');

        const badge = document.getElementById('statusBadge');
        const details = data.details || {};
        const isSuccess = (data.result === 'valid');

        // 1. Estado General
        if(isSuccess) {
            badge.innerText = "VALID ‚úÖ";
            badge.className = "badge valid";
        } else {
            badge.innerText = "INVALID ‚ùå";
            badge.className = "badge revoked";
        }

        // 2. Checks Individuales (Visualizaci√≥n Inteligente)
        // Usamos los detalles devueltos o inferimos por el resultado global
        
        // Firma Criptogr√°fica
        updateCheck('checkSig', isSuccess || data.flag !== 'invalid_signature');
        
        // Nonce
        if (data.flag === 'nonce_invalid' || data.flag === 'nonce_used' || data.flag === 'nonce_expired') {
            updateCheck('checkNonce', false, "FALLO (Replay/Expirado)");
        } else if (document.getElementById('nonceInput').value) {
            updateCheck('checkNonce', true, "VERIFICADO");
        } else {
            updateCheck('checkNonce', true, "OMITIDO (Riesgo)");
            document.getElementById('checkNonce').style.color = "#fcd34d"; // Amarillo warning
        }

        // Estado Revocaci√≥n
        if (data.flag === 'revoked') {
            updateCheck('checkStatus', false, "REVOCADA");
        } else if (isSuccess) {
            updateCheck('checkStatus', true, "ACTIVA");
        } else {
            // Si fall√≥ antes (firma), no llegamos a mirar estado
            updateCheck('checkStatus', false, "NO VERIFICADO");
            document.getElementById('checkStatus').style.color = "var(--muted)";
        }

        // 3. Metadatos
        document.getElementById('resIss').innerText = details.iss || 'Desconocido';
        document.getElementById('resJti').innerText = details.jti || 'Desconocido';

        // 4. Claims o Error
        const box = document.getElementById('claimsBox');
        if(isSuccess) {
            // Decodificamos el payload para mostrar los datos de negocio
            const payload = parseJwt(document.getElementById('tokenInput').value);
            const subj = payload.vc ? payload.vc.credentialSubject : {};
            box.innerText = JSON.stringify(subj, null, 2);
            box.style.color = "#cbd5e1";
        } else {
            // Mostramos la raz√≥n del fallo
            let errorMsg = "Motivo del rechazo: ";
            if (data.flag) errorMsg += data.flag.toUpperCase();
            if (details.msg) errorMsg += `\nDetalle: ${details.msg}`;
            if (details.error) errorMsg += `\nError T√©cnico: ${details.error}`;
            
            box.innerText = errorMsg;
            box.style.color = "#f87171"; // Rojo
        }
    }

    function updateCheck(elementId, isOk, customText=null) {
        const el = document.getElementById(elementId);
        if (isOk) {
            el.innerText = customText || "OK";
            el.style.color = "#4ade80"; // Verde
        } else {
            el.innerText = customText || "FALLO";
            el.style.color = "#f87171"; // Rojo
        }
    }

    // Helper para decodificar JWT en cliente (solo visualizaci√≥n)
    function parseJwt (token) {
        try {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            return {};
        }
    }
</script>
{% endblock %}
