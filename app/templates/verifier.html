<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>DAP - Verifier</title>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        h1 { grid-column: 1 / -1; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 20px; }

        .card { background-color: #1e293b; padding: 20px; border-radius: 8px; border: 1px solid #334155; }
        .label { display: block; font-size: 0.85em; color: #94a3b8; margin-bottom: 5px; font-weight: bold; }

        input, textarea { 
            width: 100%; box-sizing: border-box; background: #0f172a; border: 1px solid #334155; 
            color: white; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-family: monospace;
        }
        
        textarea { 
            min-height: 120px; 
            word-break: break-all; 
            resize: vertical;
        }

        .btn { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 1em; width: 100%; transition: background 0.2s; }
        .btn:hover { background: #1d4ed8; }
        .btn-secondary { background: #475569; margin-bottom: 10px; }
        .btn-secondary:hover { background: #334155; }

        /* Resultado */
        .result-box {
            background: #0f172a;
            border: 1px solid #334155;
            padding: 15px;
            border-radius: 4px;
            min-height: 200px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 15px;
            background: #334155;
            color: #94a3b8;
        }
        .status-valid { background: #064e3b; color: #4ade80; border: 1px solid #059669; }
        .status-invalid { background: #7f1d1d; color: #f87171; border: 1px solid #dc2626; }

        .check-item { margin-bottom: 5px; display: flex; justify-content: space-between; border-bottom: 1px solid #1e293b; padding-bottom: 2px;}
        .check-key { color: #94a3b8; }
        .check-val { font-family: monospace; }
        .check-ok { color: #4ade80; }
        .check-err { color: #f87171; }

    </style>
</head>
<body>

    <h1>Verifier <span style="font-size:0.5em; color:#64748b;">| Auditoría de Credenciales</span></h1>

    <div class="container">
        
        <div class="card">
            
            <div style="border-bottom: 1px solid #334155; padding-bottom: 15px; margin-bottom: 15px;">
                <div class="label">PASO 1: Obtener Reto (Anti-Replay)</div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" style="width: auto;" onclick="getChallenge()">1. Pedir Challenge</button>
                    <input type="text" id="nonceInput" placeholder="Nonce..." readonly style="margin-bottom:0;">
                </div>
            </div>

            <div>
                <div class="label">PASO 2: Token a Verificar</div>
                <textarea id="tokenInput" placeholder="Pega aquí el VC-JWT completo (eyJ...)"></textarea>
                
                <button class="btn" onclick="verifyCredential()">2. Verificar Integridad y Validez</button>
            </div>
        </div>

        <div class="card">
            <div class="label">Informe de Verificación</div>
            <div class="result-box">
                <div id="statusBadge" class="status-badge">ESPERANDO DATOS</div>
                
                <div id="checksContainer" style="display:none;">
                    <div class="check-item">
                        <span class="check-key">Firma Criptográfica (RS256)</span>
                        <span id="resSig" class="check-val">--</span>
                    </div>
                    <div class="check-item">
                        <span class="check-key">Nonce (Anti-Replay)</span>
                        <span id="resNonce" class="check-val">--</span>
                    </div>
                    <div class="check-item">
                        <span class="check-key">Emisor (DID)</span>
                        <span id="resIss" class="check-val">--</span>
                    </div>
                    <div class="check-item">
                        <span class="check-key">ID Credencial (JTI)</span>
                        <span id="resJti" class="check-val">--</span>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <div class="label">Datos Extraídos / Errores:</div>
                        <pre id="claimsBox" style="color: #cbd5e1; font-size: 0.9em; white-space: pre-wrap;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. Obtener Challenge
        async function getChallenge() {
            try {
                const res = await fetch('/verifier/challenge?ttl=120');
                const data = await res.json();
                document.getElementById('nonceInput').value = data.nonce;
                
                // Visual reset
                document.getElementById('statusBadge').innerText = "LISTO PARA VERIFICAR";
                document.getElementById('statusBadge').className = "status-badge";
                document.getElementById('statusBadge').style.background = "#0f172a";
            } catch(e) {
                alert("Error conectando con servidor");
            }
        }

        // 2. Verificar
        async function verifyCredential() {
            const token = document.getElementById('tokenInput').value.trim();
            const nonce = document.getElementById('nonceInput').value.trim();

            if(!token) return alert("Por favor pega un token");

            // UI Loading
            document.getElementById('statusBadge').innerText = "VERIFICANDO...";
            
            try {
                const res = await fetch('/verifier/verify', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ token: token, nonce: nonce || null })
                });
                const data = await res.json();

                renderResult(data);

            } catch(e) {
                alert("Error en verificación: " + e.message);
            }
        }

        function renderResult(data) {
            const box = document.getElementById('checksContainer');
            box.style.display = 'block';

            const badge = document.getElementById('statusBadge');
            const details = data.details || {};

            // 1. Estado General
            if(data.result === 'valid') {
                badge.innerText = "VALID ✅";
                badge.className = "status-badge status-valid";
            } else {
                badge.innerText = "INVALID ❌";
                badge.className = "status-badge status-invalid";
            }

            // 2. Checks Individuales (Con protección contra nulos)
            
            // Firma: si no viene el dato, asumimos error o desconocido, pero no explotamos
            let sigText = details.error || (details.signature ? 'OK' : '--');
            setCheck('resSig', details.signature === 'ok', sigText);
            
            // Nonce: si no viene el dato, ponemos '--'
            let nonceText = details.nonce || '--';
            let nonceOk = (details.nonce === 'ok' || details.nonce === 'skipped');
            if (details.nonce === 'skipped') nonceText = "OMITIDO (Riesgo)";
            
            setCheck('resNonce', nonceOk, nonceText);

            document.getElementById('resIss').innerText = details.iss || 'Desconocido';
            document.getElementById('resJti').innerText = details.jti || 'Desconocido';

            // 3. Flags de Error y Datos
            if(data.flags && data.flags.length > 0) {
                 // Si hay errores, mostramos los flags
                 document.getElementById('claimsBox').innerText = "DETALLES DEL FALLO:\n" + JSON.stringify(data.flags, null, 2);
                 
                 // Si está revocado, mostramos un mensaje específico
                 if (data.flags.includes("revoked")) {
                    document.getElementById('claimsBox').innerText += "\n\n⚠️ Esta credencial fue anulada por el emisor.";
                 }
                 
                 document.getElementById('claimsBox').style.color = "#f87171";
            } else {
                // Si es válido, decodificamos para mostrar datos bonitos
                const payload = parseJwt(document.getElementById('tokenInput').value);
                const subj = payload.vc ? payload.vc.credentialSubject : {};
                document.getElementById('claimsBox').innerText = JSON.stringify(subj, null, 2);
                document.getElementById('claimsBox').style.color = "#cbd5e1";
            }
        }

        function setCheck(id, isOk, text) {
            const el = document.getElementById(id);
            // PROTECCIÓN: Si text es null/undefined, usamos '--'
            el.innerText = (text || '--').toUpperCase();
            el.className = isOk ? "check-val check-ok" : "check-val check-err";
        }

        function parseJwt (token) {
            try {
                var base64Url = token.split('.')[1];
                var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return {};
            }
        }
    </script>
</body>
</html>