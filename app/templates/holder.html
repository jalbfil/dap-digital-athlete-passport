{% extends "base.html" %}

{% block title %}DAP ‚Äî Holder (Cartera){% endblock %}

{% block content %}
<div class="grid grid-2">
    
    <div class="card">
        <div class="card-pad">
            <h2>üì± Mi Cartera Digital</h2>
            <p class="muted" style="margin-bottom: 20px;">
                Introduce el identificador √∫nico (JTI) que te proporcion√≥ el emisor para cargar tu credencial.
            </p>

            <div class="form-group">
                <label for="holder-jti">Identificador de Credencial (JTI)</label>
                <input type="text" id="holder-jti" placeholder="Ej: vc-hyrox-..." autocomplete="off">
            </div>

            <button id="holder-load" class="btn primary" style="width: 100%; margin-top: 10px;">
                Cargar Credencial
            </button>
        </div>
    </div>

    <div class="card">
        <div class="card-pad">
            <h2>Detalles de la Credencial</h2>
            
            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border);">
                <pre id="holder-summary" style="margin: 0; white-space: pre-wrap; color: var(--accent); font-family: 'Consolas', monospace;">‚Äî Datos no cargados ‚Äî</pre>
            </div>

            <label>Token Firmado (Fragmento)</label>
            <div class="code" id="holder-token-snippet" style="min-height: 60px; font-size: 0.8em; color: var(--muted); margin-bottom: 20px;">
                ‚Äî
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <img id="holder-qr-img" src="" alt="C√≥digo QR" style="display: none; max-width: 200px; margin: 0 auto; border: 4px solid white; border-radius: 8px;">
                <p class="muted" style="font-size: 0.8em; margin-top: 10px;">Escanea este QR con la app del Verificador</p>
            </div>

            <div class="row" style="justify-content: space-between; border-top: 1px solid var(--border); padding-top: 15px;">
                <a href="#" id="holder-open-qr" target="_blank" class="btn disabled" style="flex: 1; text-align: center; margin-right: 10px;">
                    ‚¨áÔ∏è Descargar QR
                </a>
                <a href="#" id="holder-open-json" target="_blank" class="btn disabled" style="flex: 1; text-align: center;">
                    üìÑ Ver JSON Completo
                </a>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // L√≥gica espec√≠fica del Holder
    const btnHolderLoad = document.getElementById("holder-load");
    
    if (btnHolderLoad) {
        btnHolderLoad.addEventListener("click", async () => {
            const jtiInput = document.getElementById("holder-jti");
            const jti = jtiInput.value.trim();
            
            const tok = document.getElementById("holder-token-snippet");
            const sum = document.getElementById("holder-summary");
            const qrImg = document.getElementById("holder-qr-img");
            const btnQr = document.getElementById("holder-open-qr");
            const btnJson = document.getElementById("holder-open-json");

            // Reset UI
            tok.textContent = "Cargando...";
            sum.textContent = "...";
            qrImg.style.display = "none";
            
            if (!jti) {
                alert("Por favor, introduce un JTI v√°lido.");
                tok.textContent = "‚Äî";
                sum.textContent = "‚Äî";
                return;
            }

            try {
                // 1. Obtener JSON de la credencial
                const resp = await fetch(`/holder/${encodeURIComponent(jti)}.json`);
                
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || "Error al buscar credencial");
                }
                
                const data = await resp.json();

                // 2. Mostrar datos
                // Mostramos un snippet del token
                tok.textContent = (data.token || "").slice(0, 100) + "...";
                
                // Parseamos el token para mostrar el resumen (esto se hace en cliente solo para visualizar)
                // En un caso real, usar√≠amos una librer√≠a JWT, aqu√≠ hacemos un parseo b√°sico del payload
                try {
                    const payloadPart = data.token.split('.')[1];
                    const decodedPayload = JSON.parse(atob(payloadPart));
                    const subj = decodedPayload.vc.credentialSubject || {};
                    
                    sum.textContent = `EVENTO:  ${subj.event || "N/A"}\n` +
                                      `ATLETA:  ${subj.name || "N/A"}\n` +
                                      `DORSAL:  ${subj.bib || "N/A"}\n` +
                                      `TIEMPO:  ${subj.result?.time || "N/A"}`;
                } catch(e) {
                    sum.textContent = "No se pudieron decodificar los datos del token para vista previa.";
                }

                // 3. Cargar QR
                const qrUrl = `/holder/${encodeURIComponent(jti)}/qr.png`;
                qrImg.src = qrUrl;
                qrImg.style.display = "block";
                
                // 4. Activar botones
                btnQr.href = qrUrl;
                btnQr.classList.remove("disabled");
                btnJson.href = `/holder/${encodeURIComponent(jti)}.json`;
                btnJson.classList.remove("disabled");

            } catch (e) {
                alert("Error: " + e.message);
                tok.textContent = "Error";
                sum.textContent = "No encontrada";
            }
        });
    }
</script>
{% endblock %}
