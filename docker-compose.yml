version: "3.8"

services:
  dap-backend:
    # Construir imagen usando el Dockerfile del directorio actual
    build: .
    container_name: dap_container
    
    # Mapeo de Puertos (Host:Contenedor)
    ports:
      - "8000:8000"
    
    # Volúmenes: Persistencia de datos y configuración
    volumes:
      # 1. Persistencia de BD: Evita perder usuarios al reiniciar el contenedor
      - ./dap_data:/app/dap_data
      # 2. Claves Criptográficas: Inyectamos las claves generadas en el host
      # Esto permite rotar claves sin reconstruir la imagen.
      - ./app/keys:/app/app/keys
      # (Opcional) Descomentar para desarrollo "Hot Reload" (ver cambios sin rebuild)
      # - ./app:/app/app
    
    # Variables de Entorno (Configuración dinámica)
    environment:
      - ADMIN_TOKEN=supersecreto123
      # Usamos la ruta interna del contenedor para la BD
      - DATABASE_URL=sqlite+aiosqlite:///dap_data/dap.db
      # Configuración Regional para Tesseract (OCR) y Logs
      - LC_ALL=C.UTF-8
      - LANG=C.UTF-8
      # Evita que Python bufferice los logs (para verlos en tiempo real)
      - PYTHONUNBUFFERED=1

    # Política de Reinicio: Resiliencia ante fallos
    restart: unless-stopped

    # Healthcheck: El orquestador verifica que la API responda
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
